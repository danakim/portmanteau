<!DOCTYPE html>
<html>
    <head>
        <title>Portmanteau</title>
        <link rel="icon" type="image/ico" href="favicon.ico" />
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>
        <script src="jquery.min.js"></script>
        <script src="jquery-csv-min.js"></script>
        <style>
            body {
                font-family: sans-serif;
                font-size: 14px;
                background-image:url('background.png');
            }
            #map_canvas {
                height: 600px;
                width: 1200px;
                margin-top: 0.6em;
            }
            input {
                border: 1px rgba(0, 0, 0, 1);
                border-style: dotted;
                background-image: url('search.png');
                background-position: 1182px;
                background-size: 18px 18px;
                background-repeat: no-repeat;
                margin-top: 70px;
                width: 1198px;
            }
            input.notfound {
                border: 1px solid  rgba(255, 0, 0, 0.4);
                border-style: dotted;
                background-image: url('search.png');
                background-position: 1182px;
                background-size: 18px 18px;
                background-repeat: no-repeat;
                margin-top: 70px;
                width: 1198px;
            }
        </style>

        <script>
            var map;
            var cityName;
            var markersArray = [];
            var building_image = new google.maps.GroundOverlay("image_area.png");
            var map_center = new google.maps.LatLng(44.427178,26.105742);
            function initialize() {
                var mapOptions = {
                    center: map_center,
                    zoom: 14,
                    mapTypeId: google.maps.MapTypeId.SATELLITE
                };
                map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);

                var input = document.getElementById('searchTextField');
                var autocomplete = new google.maps.places.Autocomplete(input);
                autocomplete.bindTo('bounds', map);

                var imageBounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(44.4032679880013,26.072268031494104),
                    new google.maps.LatLng(44.45107823568948,26.139215968505823));
                building_image = new google.maps.GroundOverlay("image_area.png",imageBounds);
                building_image.setMap(map);
                google.maps.event.addListener(building_image, 'click', function() {
                    initMarker(map_center);
                });

                google.maps.event.addListener(autocomplete, 'place_changed', function() {
                    input.className = '';
                    var place = autocomplete.getPlace();
                    var cityName = place.name

                    // If place is not found, return
                    if (!place.geometry) {
                        input.className = 'notfound';
                        return;
                    }

                    // If place is Bucharest / Bucuresti, set a special center to place the image correctly
                    if (cityName == 'Bucharest' || cityName == 'Bucuresti') {
                        var map_center = new google.maps.LatLng(44.427178,26.105742);
                    } else {
                        var map_center = place.geometry.location
                    }
                    // Place the image on the map at the searched location
                    building_image.setMap(null);
                    map.setCenter(map_center);
                    map.setZoom(14);
                    setImage(map_center);

                    // Get the city name and look for it through the city database for population and area info
                    $(document).ready(function() {
                        $.ajax({
                            type: "GET",
                            url: "city_database.txt",
                            dataType: "text",
                            success: function(data) {processCsv(data);}
                        });
                    });
                    function processCsv(csv_data) {
                        var lines = [];
                        var lines = $.csv.toObjects(csv_data);

                        var area = $.map(lines, function(val) {
                            return val.name == cityName ? val.area : null;
                        });
                        var density = $.map(lines, function(val) {
                            return val.name == cityName ? val.density : null;
                        });

                        if (area.length == 0 || density.length == 0) {
                            document.getElementById('area').innerHTML = "No data"
                            document.getElementById('population').innerHTML = "No data"
                            return;
                            } else {
                            population_displaced = parseFloat(4.50) * parseFloat(density[0]);
                            surface_displaced = ((parseFloat(4.50) / parseFloat(area[0])) * parseFloat(100)).toFixed(1);
                            document.getElementById('area').innerHTML = surface_displaced + "%"
                            document.getElementById('population').innerHTML = population_displaced
                        }
                    }
                    google.maps.event.addListener(building_image, 'click', function() {
                        initMarker(map_center);
                    });
                });
            }

            function setImage(center) {
                //map.setZoom(14);
                //var scale = Math.pow(2,map.getZoom());
                var scale = Math.pow(2,14);
                var proj = map.getProjection();
                var wc = proj.fromLatLngToPoint(center);
                var bounds = new google.maps.LatLngBounds();
                var sw = new google.maps.Point(((wc.x * scale) - 390)/ scale, ((wc.y * scale) - 390)/ scale);
                bounds.extend(proj.fromPointToLatLng(sw));
                var ne = new google.maps.Point(((wc.x * scale) + 390)/ scale, ((wc.y * scale) + 390)/ scale);
                bounds.extend(proj.fromPointToLatLng(ne));
                building_image = new google.maps.GroundOverlay("image_area.png",bounds);
                building_image.setMap(map);
            }

            function initMarker(location) {
                if (markersArray) {
                    for (i in markersArray) {
                        markersArray[i].setMap(null);
                    }
                markersArray.length = 0;
                }
                marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: 'buldozer.png',
                    draggable: true
                });
                google.maps.event.addListener(marker, 'dragend', function(event) {
                    building_image.setMap(null);
                    setImage(marker.getPosition());
                });
                markersArray.push(marker);
            }

            google.maps.event.addDomListener(window, 'load', initialize);
        </script>
    </head>
    <body>
        <img src="portmanteau.png" alt="Portmanteau" height="45" width="230" style="position:absolute; top:18px; left:18px;">
        <div>
            <input id="searchTextField" type="text" size="150">
        </div>
        <div id="map_canvas"></div>
        <div id="upper_text" name="upper_text" style="font-family:sans-serif; font-size:12px; border-style:solid; border-width:2px; position:absolute; top:83px; right:20px; height:230px; width:195px";>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed facilisis ipsum quis dui bibendum non egestas eros bibendum. Ut aliquet ipsum nec mauris lobortis ultricies. Morbi aliquam ligula ut sapien tempus ac porttitor leo blandit. Maecenas molestie ante non mi blandit varius. Donec eget nibh in nulla tristique eleifend et ut velit. In ut adipiscing odio. Quisque condimentum eros quis neque euismod non interdum nisi rhoncus. Nulla feugiat accumsan ante, quis volutpat mi interdum nec. Nulla lobortis, lorem sed congue suscipit, elit mauris faucibus nunc, eget rutrum
        </div>
        <div id="population" name="population" title="Population displaced" style="font-family:sans-serif; font-size:40px; font-weight:bold; border:hidden; position:absolute; top:328px; right:20px;";>
            30600
        </div>
        <div id="area" name="area" title="Area displaced" style="font-family:sans-serif; font-size:40px; font-weight:bold; border:hidden; position:absolute; top:410px; right:20px;";>
            1.6%
        </div>
        <div id="lower_text" name="lower_text" style="font-family:sans-serif; font-size:12px; border-style:solid; border-width:2px; position:absolute; top:460px; right:20px; height:220px; width:195px";>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed facilisis ipsum quis dui bibendum non egestas eros bibendum. Ut aliquet ipsum nec mauris lobortis ultricies. Morbi aliquam ligula ut sapien tempus ac porttitor leo blandit. Maecenas molestie ante non mi blandit varius. Donec eget nibh in nulla tristique eleifend et ut velit. In ut adipiscing odio. Quisque condimentum eros quis neque euismod non interdum nisi rhoncus. Nulla feugiat accumsan ante, quis volutpat mi interdum nec. Nulla lobortis, lorem sed congue suscipit, elit mauris faucibus nunc
        </div>
     </body>
</html>
