<!DOCTYPE html>
<html>
    <head>
        <title>portmanteau.ro</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="description" content="A tale of schizophrenic urbanism" />
        <meta name="keywords" content="bucuresti,bucharest,portmanteau,casa poporului,people's house,centrul civic,civic centre,victoria socialismului,comunism,communism,demolari,distrugere,destruction" />
        <link rel="icon" type="image/ico" href="favicon.ico" />
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js" type="text/javascript"></script>
        <script src="jquery-csv-min.js"></script>
        <style>
            body {
                font-family: monospace;
                font-size: 14px;
            }
            #map_canvas {
                position: absolute;
                top: 127px;
                left: 9px;
                height: 600px;
                width: 1198px;
            }
            input {
                border: 1px rgba(0, 0, 0, 1);
                border-style: dotted;
                background-image: url('search.png');
                background-position: 1176px;
                background-size: 18px 18px;
                background-repeat: no-repeat;
                font-family: monospace;
                font-size: 13px;
                height: 20px;
                width: 1196px;
                position: absolute;
                top: 93px;
                left: 9px;
            }
            input.notfound {
                border: 1px solid  rgba(255, 0, 0, 0.4);
                border-style: dotted;
                background-image: url('search.png');
                background-position: 1176px;
                background-size: 18px 18px;
                background-repeat: no-repeat;
                font-family: monospace;
                font-size: 13px;
                height: 20px;
                width: 1196px;
                position: absolute;
                top: 93px;
                left: 9px;
            }
        </style>

        <script>
            // Global variables
            var map;
            var cityName;
            var markersArray = [];
            var image_clicked = 0;
            var building_image = new google.maps.GroundOverlay("image_area.png");
            var map_center = new google.maps.LatLng(44.427178,26.105742);
            function initialize() {
                // Initially center the map over Bucharest and place the image on top of it
                var mapOptions = {
                    center: map_center,
                    zoom: 14,
                    mapTypeId: google.maps.MapTypeId.SATELLITE
                };
                map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);

                var input = document.getElementById('searchTextField');
                var autocomplete = new google.maps.places.Autocomplete(input);
                autocomplete.bindTo('bounds', map);

                var imageBounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(44.4032679880013,26.072268031494104),
                    new google.maps.LatLng(44.45107823568948,26.139215968505823));
                building_image = new google.maps.GroundOverlay("image_area.png",imageBounds);
                building_image.setMap(map);
                addClickListener(map_center);

                // Add a listener for when the user searches for a place
                google.maps.event.addListener(autocomplete, 'place_changed', function() {
                    input.className = '';
                    image_clicked = 0;
                    var place = autocomplete.getPlace();
                    var cityName = place.name

                    // If place is not found, return
                    if (!place.geometry) {
                        input.className = 'notfound';
                        return;
                    }

                    // If place is Bucharest / Bucuresti, set a special center to place the image correctly
                    if (cityName == 'Bucharest' || cityName == 'Bucuresti') {
                        var map_center = new google.maps.LatLng(44.427178,26.105742);
                    } else {
                        var map_center = place.geometry.location
                    }
                    // Place the image on the map at the searched location
                    building_image.setMap(null);
                    map.setCenter(map_center);
                    map.setZoom(14);
                    setImage(map_center);

                    // Get the city name and look for it through the city database for population and area info
                    $(document).ready(function() {
                        $.ajax({
                            type: "GET",
                            url: "city_database.txt",
                            dataType: "text",
                            success: function(data) {processCsv(data);}
                        });
                    });
                    function processCsv(csv_data) {
                        var lines = [];
                        var lines = $.csv.toObjects(csv_data);

                        var area = $.map(lines, function(val) {
                            return val.name == cityName ? val.area : null;
                        });
                        var density = $.map(lines, function(val) {
                            return val.name == cityName ? val.density : null;
                        });

                        if (area.length == 0 || density.length == 0) {
                            document.getElementById('area').innerHTML = "0.0%"
                            document.getElementById('population').innerHTML = "0"
                            return;
                            } else {
                            population_displaced = parseFloat(4.50) * parseFloat(density[0]);
                            surface_displaced = ((parseFloat(4.50) / parseFloat(area[0])) * parseFloat(100)).toFixed(1);
                            document.getElementById('area').innerHTML = surface_displaced + "%"
                            document.getElementById('population').innerHTML = population_displaced
                        }
                    }
                    // Add a listener for a click on the image to toggle the marker
                    addClickListener(map_center);
                });
            }

            // The function that creates the image overlay relative to a coordinate
            function setImage(center) {
                //map.setZoom(14);
                //var scale = Math.pow(2,map.getZoom());
                var scale = Math.pow(2,14);
                var proj = map.getProjection();
                var wc = proj.fromLatLngToPoint(center);
                var bounds = new google.maps.LatLngBounds();
                var sw = new google.maps.Point(((wc.x * scale) - 390)/ scale, ((wc.y * scale) - 390)/ scale);
                bounds.extend(proj.fromPointToLatLng(sw));
                var ne = new google.maps.Point(((wc.x * scale) + 390)/ scale, ((wc.y * scale) + 390)/ scale);
                bounds.extend(proj.fromPointToLatLng(ne));
                building_image = new google.maps.GroundOverlay("image_area.png",bounds);
                building_image.setMap(map);
            }

            // Cleans all the existing markers
            function cleanMarker() {
                if (markersArray) {
                    for (i in markersArray) {
                        markersArray[i].setMap(null);
                    }
                markersArray.length = 0;
                }
            }

            // Adds a custom marker used to move the image overlay
            function initMarker(location) {
                cleanMarker();
                marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: 'buldozer.png',
                    draggable: true
                });
                // When dragging the marker has ended, reposition the image overlay
                google.maps.event.addListener(marker, 'dragend', function(event) {
                    building_image.setMap(null);
                    setImage(marker.getPosition());
                    addClickListener(marker.getPosition());
                });
                markersArray.push(marker);
                image_clicked = 1;
            }

            // Adds a listener for when the image overlay is clicked to toggle the marker on / off
            function addClickListener(marker_position) {
                google.maps.event.addListener(building_image, 'click', function() {
                    if (image_clicked == 1) {
                        cleanMarker();
                        image_clicked = 0;
                    } else {
                        initMarker(marker_position);
                    }
                });
            }

            function random() {
                    var searchBox = document.getElementById("searchTextField");
                    searchBox.value = "Randomizing..."
                    $(document).ready(function() {
                        $.ajax({
                            type: "GET",
                            url: "city_database.txt",
                            dataType: "text",
                            success: function(data) {getRandom(data);}
                        });
                    });
                    function getRandom(csv_data) {
                        // Get a random city object from the array, map it and set variables accordingly
                        var cities = [];
                        var cities = $.csv.toObjects(csv_data);
                        var random_city = [];
                        var random_city = cities[Math.floor(Math.random() * cities.length)];
                        var city = $.map(random_city, function(val) {
                            return val;
                        });
                        cityName = city[0];
                        cityArea = city[2];
                        cityDensity = city[3];
                        // Generate the JSON url to GET from the Google geocoding service using the random city name
                        var json_url = "http://maps.googleapis.com/maps/api/geocode/json?address=" + cityName + "&sensor=false";
                        // Actually get the JSON url, parse it and use the info to set the image on the map and display all the other info
                        $.ajax({
                            type: 'GET',
                            url: json_url,
                            dataType: 'json',
                            success: function(data) {
                                var lat = data.results[0].geometry.location.lat;
                                var lng = data.results[0].geometry.location.lng;
                                var cityCountry = data.results[0].formatted_address;
                                var map_center = new google.maps.LatLng(lat,lng);
                                // Place the image on the map at the random location
                                cleanMarker();
                                image_clicked = 0;
                                building_image.setMap(null);
                                map.setCenter(map_center);
                                map.setZoom(14);
                                setImage(map_center);
                                population_displaced = parseFloat(4.50) * parseFloat(cityDensity);
                                surface_displaced = ((parseFloat(4.50) / parseFloat(cityArea)) * parseFloat(100)).toFixed(1);
                                document.getElementById("area").innerHTML = surface_displaced + "%"
                                document.getElementById("population").innerHTML = population_displaced
                                searchBox.value = cityCountry;
                                addClickListener(map_center);
                            }
                        });
                    }
            }

            // On DOM window load, run all of the above
            google.maps.event.addDomListener(window, 'load', initialize);
        </script>
    </head>
    <body>
        <div id="logo" style="position:absolute; top:17px; left:23px;">
            <a href="http://www.portmanteau.ro"><img style="width:300px; height:60px; border:none" src="portmanteau.png"/></a>
        </div>
        <div>
            <input id="searchTextField" type="text" size="150">
        </div>
        <div id="population_icon" style="position:absolute; top:22px; left:853px">
            <img src="population.png" height="48" width="52">
        </div>
        <div id="population" name="population" title="Displaced population" style="font-family:monospace; font-size:38px; font-weight:bold; border:hidden; position:absolute; top:30px; left:900px;";>
            30600
        </div>
        <div id="area_icon" style="position:absolute; top:22px; left:1040px">
            <img src="surface.png" height="50" width="64">
        </div>
        <div id="area" name="area" title="Demolished area" style="font-family:monospace; font-size:38px; font-weight:bold; border:hidden; position:absolute; top:30px; left:1104px;";>
            1.6%
        </div>
        <div id="random" style="position:absolute; top:93px; left:1221px">
            <a href="javascript:random()"><img style="border:none;"  src="button_random.png" height="25" width="114" /></a>
        </div>
        <div id="map_canvas"></div>
        <div id="upper_text" name="upper_text" style="font-family:monospace; font-size:11px; border:hidden; position:absolute; top:5px; left:1219px; height:73px; width:210px";>
            The symbols represent the population displaced according to the average density and the percentage of area occupied by the project relative to the surface of the city.
        </div>
        <div id="lower_text" name="lower_text" style="font-family:monospace; font-size:11px; border:hidden; position:absolute; top:132px; left:1219px; height:585px; width:205px";>
            <b>About:</b> The emphasized project in the image is perhaps the most violent scar left by a totalitarian regime through the flesh of a capital making Bucharest the most devastated European city in times of peace. The megalomaniac “Civic Centre”, a materialization of a North Korean vision of modernity, also dubbed “The Socialist Victory” is organised along a monumental axis that short-circuits the scale and the inherited logic of the city, hiding it behind a colossal order decorated mantle. Thus it establishes a new hierarchy on top of which schizophrenically thrones the largest administrative building in Europe known by us as the “House of the People”, today “The Palace of the Parliament”. This project is our baggage, the people of Bucharest’s baggage, and the question that we started with was <b>“What would happen if we were to take this baggage with us through the world?”.</b>
            <p><b>Instructions:</b> Use the search bar to change the city. The drawing will be projected over the chosen destination keeping its scale and its position will be anchored relative to the centre of the urbanization. To move the drawing, left click and move the newly appeared marker to your desired location. Another click and the marker will disappear. The “Random” button helps with the lack of inspiration!</p>
            <b>Concept and design:</br></b>Bogdan Ilie</br>Dan Achim
        </div>
        <div id="ro_lang" style="position:absolute; top:735px; left:9px;";>
            <a style="text-decoration:none;" type="icon_link" href="http://www.portmanteau.ro"><img style="width:70px; height:30px; border:none;" src="button_en.png"/></a>
        </div>
        <div id="facebook_button" style="position:absolute; top:735px; left:1142px;";>
            <a target="_blank" style="text-decoration:none;" type="icon_link" href="http://www.facebook.com/sharer.php?s=100&p[title]=A tale of schizophrenic urbanism&p[url]=http://www.portmanteau.ro&p[images][0]=http://www.portmanteau.ro/portmanteau_logo.png"><img style="width:30px; height:30px; border:none;" src="button_fb.png"/></a>
        </div>
        <div id="twitter_button" style="position:absolute; top:735px; left:1177px;";>
            <a target="_blank" style="text-decoration:none;" type="icon_link" href="https://twitter.com/share?url=http://www.portmanteau.ro"><img style="width:30px; height:30px; border:none;" src="button_tw.png"/></a>
        </div>
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-38193417-1']);
            _gaq.push(['_trackPageview']);

            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
    </body>
</html>
